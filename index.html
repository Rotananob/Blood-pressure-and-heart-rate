<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áŸá˜áŸ’á–á¶á’áˆá¶á˜ á“á·á„ á”áŸáŸ‡áŠá¼á„ </title>
    <link rel="icon" href="icon.jpg">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
        body {
            font-family: 'Khmer OS Battambang', Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #9b59b6; /* á–ááŸŒáŸáŸ’áœá¶á™ááŸ’á˜á¸ */
            color: white;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .card {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Form and Input Styles */
        input[type="date"], input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .voice-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #voice-btn {
            background-color: #e74c3c; /* á€áŸ’ášá á˜ */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #voice-btn:hover {
            background-color: #c0392b;
        }
        
        #voice-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        #voice-status {
            color: #2c3e50;
            font-style: italic;
        }

        button[type="submit"] {
            background-color: #2ecc71;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        /* Summary Boxes (KPIs) */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-box {
            background-color: #f7f7f7;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #9b59b6;
            margin: 5px 0;
        }
        
        .kpi-status-text {
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Chart Area */
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            height: 350px; 
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ—£ï¸ á€á˜áŸ’á˜áœá·á’á¸áœá·á—á¶á‚áŸá˜áŸ’á–á¶á’áˆá¶á˜áá¶á˜ášá™áŸ‡áŸáŸ†á¡áŸá„</h1>
    </header>

    <div class="container">
        
        <div class="card form-card">
            <h2>á”á‰áŸ’á…á¼á›áŠáŸ„á™á”áŸ’ášá¾áŸáŸ†á¡áŸá„ á¬á¢á€áŸ’áŸáš</h2>
            <div class="voice-section">
                <button id="voice-btn">ğŸ”Š á…á¶á”áŸ‹á•áŸ’áá¾á˜á“á·á™á¶á™</button>
                <span id="voice-status">á…á»á…á”áŸŠá¼áá»á„áŠá¾á˜áŸ’á”á¸á“á·á™á¶á™!</span>
            </div>
            
            <form id="vitals-form">
                <label for="date">á€á¶á›á”ášá·á…áŸ’á†áŸá‘:</label>
                <input type="date" id="date" required>

                <label for="systolic">áŸá˜áŸ’á–á¶á’áˆá¶á˜á›á¾ (Systolic):</label>
                <input type="number" id="systolic" placeholder="á§á‘á¶á ášááŸ: 120" required>
                
                <label for="diastolic">áŸá˜áŸ’á–á¶á’áˆá¶á˜á€áŸ’ášáŸ„á˜ (Diastolic):</label>
                <input type="number" id="diastolic" placeholder="á§á‘á¶á ášááŸ: 80" required>

                <label for="pulse">á…á„áŸ’áœá¶á€áŸ‹á”áŸáŸ‡áŠá¼á„ (Pulse / bpm):</label>
                <input type="number" id="pulse" placeholder="á§á‘á¶á ášááŸ: 75" required>

                <button type="submit">ášá€áŸ’áŸá¶á‘á»á€á€áŸ†áááŸ‹ááŸ’ášá¶</button>
                <p id="save-message" class="message"></p>
            </form>
        </div>

        <div class="summary-grid">
            <div class="summary-box">
                <h3>BP á…á»á„á€áŸ’ášáŸ„á™ (Systolic)</h3>
                <p id="latest-systolic" class="kpi-value">-</p>
                <span id="bp-status" class="kpi-status-text">-</span>
            </div>
            <div class="summary-box">
                <h3>Pulse á…á»á„á€áŸ’ášáŸ„á™</h3>
                <p id="latest-pulse" class="kpi-value">-</p>
                <span id="pulse-status" class="kpi-status-text">-</span>
            </div>
            <div class="summary-box">
                <h3>á€áŸ†áááŸ‹ááŸ’ášá¶áŸášá»á”</h3>
                <p id="record-count" class="kpi-value">0</p>
            </div>
        </div>

        <div class="card chart-container">
            <h3>á“á·á“áŸ’á“á¶á€á¶ášáŸá˜áŸ’á–á¶á’áˆá¶á˜ (BP Trend)</h3>
            <canvas id="bpChart"></canvas>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const STORAGE_KEY = 'vitalsRecords';
            const vitalsForm = document.getElementById('vitals-form');
            const saveMessageEl = document.getElementById('save-message');
            const voiceBtn = document.getElementById('voice-btn');
            const voiceStatusEl = document.getElementById('voice-status');

            let bpChartInstance = null;

            // ------------------------------------
            // LocalStorage Utilities
            // ------------------------------------

            function loadRecords() {
                const data = localStorage.getItem(STORAGE_KEY);
                const records = data ? JSON.parse(data) : [];
                // áá˜áŸ’ášáŸ€á”áá¶á˜á€á¶á›á”ášá·á…áŸ’á†áŸá‘
                return records.sort((a, b) => new Date(a.date) - new Date(b.date)); 
            }

            function saveRecord(newRecord) {
                const records = loadRecords();
                const existingIndex = records.findIndex(r => r.date === newRecord.date);
                
                if (existingIndex !== -1) {
                    records[existingIndex] = newRecord;
                } else {
                    records.push(newRecord);
                }

                localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            }

            // ------------------------------------
            // Voice Recognition Logic
            // ------------------------------------
            
            // á–á·á“á·ááŸ’á™á˜á¾á› Browser Support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US'; // á”áŸ’ášá¾ English áŠá¾á˜áŸ’á”á¸á„á¶á™áŸáŸ’ášá½á›á‘á¶á‰á™á€á›áŸá
                recognition.interimResults = false;

                voiceBtn.addEventListener('click', () => {
                    // á€áŸ†áááŸ‹á€á¶á›á”ášá·á…áŸ’á†áŸá‘á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“áŠáŸ„á™áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date').value = today;
                    
                    recognition.start();
                    voiceStatusEl.textContent = "á€áŸ†á–á»á„áŸáŸ’áá¶á”áŸ‹... (á§á‘á¶á ášááŸáŸ– one twenty over eighty, pulse seventy-five)";
                });
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    voiceStatusEl.textContent = `á”á¶á“á‘á‘á½á›: "${transcript}"`;
                    
                    // Regex áŠá¾á˜áŸ’á”á¸á‘á¶á‰á™á€á›áŸá (numbers) áŠáŸ‚á›á˜á¶á“á™áŸ‰á¶á„áá·á… 2 ááŸ’á‘á„áŸ‹
                    // (á§á‘á¶á ášááŸ: 120, 80, 75)
                    const numbers = transcript.match(/\b\d{2,3}\b/g); 
                    
                    if (numbers && numbers.length >= 3) {
                        // áŸá“áŸ’á˜ááá¶á›áŸá 3 áŠáŸ†á”á¼á„á‚áº Systolic, Diastolic, á“á·á„ Pulse
                        document.getElementById('systolic').value = numbers[0];
                        document.getElementById('diastolic').value = numbers[1];
                        document.getElementById('pulse').value = numbers[2];
                        
                        saveMessageEl.textContent = "á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¼áœá”á¶á“á”á‰áŸ’á…á¼á›áŠáŸ„á™áŸáŸ†á¡áŸá„! áŸá¼á˜á…á»á…ášá€áŸ’áŸá¶á‘á»á€áŸ”";
                        setTimeout(() => saveMessageEl.textContent = '', 4000);
                    } else {
                        saveMessageEl.textContent = "á˜á·á“á¢á¶á…á‘á¶á‰á™á€á›áŸááŸá˜áŸ’á–á¶á’áˆá¶á˜ á“á·á„ Pulse á”á¶á“á‘áŸáŸ” áŸá¼á˜áŸá¶á€á›áŸ’á”á„á“á·á™á¶á™á˜áŸ’áá„á‘áŸ€ááŸ”";
                    }
                };

                recognition.onerror = function(event) {
                    if (event.error === 'not-allowed') {
                         voiceStatusEl.textContent = "á€áŸ†á á»áŸ! á¢áŸ’á“á€á”á¶á“á”áŠá·áŸáŸá’á€á¶ášá¢á“á»á‰áŸ’á‰á¶áá”áŸ’ášá¾á˜á¸á€áŸ’ášá¼á áŸ’áœá¼á“áŸ” (ááŸ’ášá¼áœáŠáŸ†áá¾ášá€á¶ášá›á¾ Local Server)";
                    } else if (event.error === 'no-speech') {
                         voiceStatusEl.textContent = "á…á”áŸ‹á€á¶ášáŸáŸ’áá¶á”áŸ‹áŸ” (á˜á·á“á˜á¶á“áŸáŸ†á¡áŸá„á…á¶á”áŸ‹á”á¶á“á‘áŸ)";
                    } else {
                         voiceStatusEl.textContent = `á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášáŸáŸ’áá¶á”áŸ‹áŸ– ${event.error}`;
                    }
                    voiceStatusEl.style.color = '#e74c3c';
                };
                
                recognition.onend = function() {
                     if (!saveMessageEl.textContent) {
                         voiceStatusEl.textContent = "á…á”áŸ‹á€á¶ášáŸáŸ’áá¶á”áŸ‹áŸ”";
                     }
                     voiceStatusEl.style.color = '#2c3e50';
                }

            } else {
                voiceStatusEl.textContent = "Browser ášá”áŸáŸ‹á¢áŸ’á“á€á˜á·á“á‚á¶áŸ†á‘áŸ’áš Web Speech API á‘áŸáŸ” áŸá¼á˜á”áŸ’ášá¾ Google Chrome á¬ EdgeáŸ”";
                voiceBtn.disabled = true;
            }

            // ------------------------------------
            // Form Handling (Save Data)
            // ------------------------------------

            vitalsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const date = document.getElementById('date').value;
                const systolic = parseInt(document.getElementById('systolic').value);
                const diastolic = parseInt(document.getElementById('diastolic').value);
                const pulse = parseInt(document.getElementById('pulse').value);
                
                if (isNaN(systolic) || isNaN(diastolic) || isNaN(pulse) || !date) {
                    saveMessageEl.textContent = "áŸá¼á˜á”á‰áŸ’á…á¼á›áá½á›áŸáááŸ’ášá¹á˜ááŸ’ášá¼áœ!";
                    return;
                }

                const newRecord = { date, systolic, diastolic, pulse };
                saveRecord(newRecord);
                
                saveMessageEl.textContent = "ášá€áŸ’áŸá¶á‘á»á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!";
                vitalsForm.reset();
                
                updateDashboard();
                
                setTimeout(() => saveMessageEl.textContent = '', 2000);
            });

            // ------------------------------------
            // Dashboard Rendering (Chart.js & KPIs)
            // ------------------------------------
            
            function getBPStatus(sys, dia) {
                if (sys >= 140 || dia >= 90) return { text: 'áŸá˜áŸ’á–á¶á’áˆá¶á˜ááŸ’á–áŸáŸ‹', color: '#e74c3c' };
                if (sys >= 130 && dia < 80) return { text: 'áŸá˜áŸ’á–á¶á’áˆá¶á˜á¡á¾á„', color: '#f39c12' };
                if (sys < 120 && dia < 80) return { text: 'á’á˜áŸ’á˜áá¶', color: '#2ecc71' };
                return { text: 'á¡á¾á„/á…á»áŸ‡á”á“áŸ’áá·á…á”á“áŸ’áá½á…', color: '#3498db' };
            }
            
            function getPulseStatus(pulse) {
                if (pulse > 100) return { text: 'á›á¿á“', color: '#e74c3c' };
                if (pulse < 60) return { text: 'á™áºá', color: '#f39c12' };
                return { text: 'á’á˜áŸ’á˜áá¶', color: '#2ecc71' };
            }
            

            function updateDashboard() {
                const records = loadRecords();
                const recordCountEl = document.getElementById('record-count');
                recordCountEl.textContent = records.length;

                if (records.length === 0) {
                     // Clear KPIs
                     document.getElementById('latest-systolic').textContent = '-';
                     document.getElementById('bp-status').textContent = '-';
                     document.getElementById('latest-pulse').textContent = '-';
                     document.getElementById('pulse-status').textContent = '-';
                     if (bpChartInstance) bpChartInstance.destroy();
                     return;
                }

                const latestRecord = records[records.length - 1];
                const bpStatus = getBPStatus(latestRecord.systolic, latestRecord.diastolic);
                const pulseStatus = getPulseStatus(latestRecord.pulse);

                // --- Update KPIs ---
                document.getElementById('latest-systolic').textContent = `${latestRecord.systolic}/${latestRecord.diastolic}`;
                document.getElementById('bp-status').textContent = bpStatus.text;
                document.getElementById('bp-status').style.color = bpStatus.color;
                
                document.getElementById('latest-pulse').textContent = `${latestRecord.pulse} bpm`;
                document.getElementById('pulse-status').textContent = pulseStatus.text;
                document.getElementById('pulse-status').style.color = pulseStatus.color;
                
                // --- Render Chart ---
                renderBPChart(records);
            }

            function renderBPChart(records) {
                if (bpChartInstance) bpChartInstance.destroy();
                
                const chartData = records.slice(-30);
                
                const ctx = document.getElementById('bpChart').getContext('2d');
                bpChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.map(r => r.date),
                        datasets: [
                            {
                                label: 'Systolic (áŸá˜áŸ’á–á¶á’á›á¾)',
                                data: chartData.map(r => r.systolic),
                                borderColor: '#9b59b6', // áŸáŸ’áœá¶á™
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Diastolic (áŸá˜áŸ’á–á¶á’á€áŸ’ášáŸ„á˜)',
                                data: chartData.map(r => r.diastolic),
                                borderColor: '#3498db', // ááŸ€áœ
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Pulse (á…á„áŸ’áœá¶á€áŸ‹á”áŸáŸ‡áŠá¼á„)',
                                data: chartData.map(r => r.pulse),
                                borderColor: '#e67e22', // á‘á¹á€á€áŸ’ášá¼á…
                                tension: 0.1,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: false } }
                    }
                });
            }

            // ------------------------------------
            // á…á¶á”áŸ‹á•áŸ’áá¾á˜á€á˜áŸ’á˜áœá·á’á¸
            // ------------------------------------
            updateDashboard(); // á•áŸ’á‘á»á€ KPI á“á·á„ Chart á–áŸá›á…á¶á”áŸ‹á•áŸ’áá¾á˜
        });
    </script>
</body>
</html>
